## Walkthrough 

IP: 10.10.10.100
### Reconnaissance

Started with a Nmap scan to get all open ports along with its services and versions
```
nmap -sC -sV -A 10.10.10.100 -oA nmap/nmap_scan
```
From the scan result, it is shown that the server that we are dealing with is a Microsoft Active Directory Server 

At first glance a few notable ports and services that are interesting are: 
- SMB - 445, 139 
- Kerberos - 88 

### Enumeration 
#### SMB 
Lets start with the SMB enumeration,
1. List out all of the SMB shares 
	```bash 
	smbclient -L //10.10.10.100 
	```
	```
	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Replication     Disk      
	SYSVOL          Disk      Logon server share 
	Users           Disk 
	```
2. Check if any of the shares is accessible without credentials 
	1. `Replication` is accessible - `smbclient //10.10.10.100/Replication`  ![](assets/Pasted%20image%2020250809174212.png)
	2. From there, dump all the content within the share to host machine (for ease of viewing), here are the smb commands 
		1. `recurse ON`
		2. `mget *` - proceed the enter `y` on all the files
	3. The `active.htb` folder that was dump, hold the `Group Policies Preference (GPP)` configuration files, which happens to have the hardcoded username and password hash for a service account - `active.htb\SVC_TGS`![](assets/Pasted%20image%2020250809174231.png)
	4. This is a huge find, the `cpassword` encryption key for GPP is leaked in a Microsoft documentation - [ref](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN)
	5. The password can be easily decrypted using a tool call `gpp-decrypt`, which would give us `GPPstillStandingStrong2k18` as the password 
		```
		gpp-decrypt 'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'	
		```

**tldr;**
This configuration is for GPP (Group Policies Preference), the cPassword encrypted password is shown in `Group.xml` and the AES key is expose in Microsoft documentation

##### User Flag
Now that we have the credential `active.htb\SVC_TGS:GPPstillStandingStrong2k18` we can further enumerate the SMB share with a valid credential 

Using this credential, we would be able to access `Users` share, and from there we will be able to access the `SVC_TGS` directory and obtain the user flag from the Desktop  ![](assets/Pasted%20image%2020250809174242.png)
#### Kerberos 
As one of the service is running kerberos, we can try to enumerate the kerberos service also known as kerberoasting.

Within `impacket` there is a script - `GetUserSPNs` that allow user to enumerate kerberos's Service Principal Name (SPN) using a valid credentials (which we have in our case). 

```
impacket-GetUserSPNs -request -dc-host active.htb active.htb/SVC_TGS
```
![](assets/Pasted%20image%2020250809174258.png)

From that, we received the Administrator SPNs along with its hashed password which can be cracked using hashcat 

From hashcat there a few modes for kerberos, after a quick google search, the mode that can be use to crack this password is `13100`![](assets/Pasted%20image%2020250809174335.png)

Here are the result of the hashcat which would give us the credential of `Administrator:Ticketmaster1968`
```bash
hashcat -m 13100 hash.admin /usr/share/wordlists/rockyou.txt
```

```bash
hashcat -m 13100 hash.admin /usr/share/wordlists/rockyou.txt --show
```
![](assets/Pasted%20image%2020250809174346.png)
##### Root Flag
Now that we have the Administrator's credentials, we can login to the SMB again and access the Administrator's Directory ![](assets/Pasted%20image%2020250809174407.png)

and with that we have gotten both the user and root flag for this box! 
#### Troubleshoot 
1. Fixing `[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)` error from impacket GetUserSPNs
	1. ![](assets/Pasted%20image%2020250809174418.png)
	2. refs:
		- https://medium.com/@danieldantebarnes/fixing-the-kerberos-sessionerror-krb-ap-err-skew-clock-skew-too-great-issue-while-kerberoasting-b60b0fe20069
		- https://0xss0rz.gitbook.io/0xss0rz/pentest/protocols/kerberos-88\